{% extends "base.html" %}
{% block title %}New Document - Step 2{% endblock %}
{% block content %}
<h1 class="fw-bold" style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">New Document - Step 2</h1>
{% if form.docxf_error %}
<div class="alert alert-danger">Generation failed: {{ form.docxf_error }}</div>
{% elif form.preview_url %}
<div class="alert alert-success">Preview ready. <a href="{{ form.preview_url }}" target="_blank">View preview</a></div>
{% endif %}
{% if errors %}
<div class="alert alert-danger">Please correct the errors below.</div>
{% endif %}
<form method="post" action="{{ url_for('new_document', step=2) }}" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="mb-3">
    <label for="template" class="form-label">Template</label>
    <select class="form-select{% if errors.template %} is-invalid{% endif %}" id="template" name="template" title="Select a template">
      <option value="">-- Select Template --</option>
      {% for group, files in template_options.items() %}
        <optgroup label="{{ group|capitalize }}">
          {% for file in files %}
            <option value="{{ group }}/{{ file }}"{% if form.template == group ~ '/' ~ file %} selected{% endif %}>{{ file }}</option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
    {% if errors.template %}<div class="invalid-feedback">{{ errors.template }}</div>{% endif %}
  </div>

  <div class="mb-3">
    <label for="upload_file" class="form-label">Upload File</label>
    <input type="file" class="form-control{% if errors.upload_file %} is-invalid{% endif %}" id="upload_file" name="upload_file" title="Upload document file">
    {% if errors.upload_file %}<div class="invalid-feedback">{{ errors.upload_file }}</div>{% endif %}
  </div>

  <div class="mb-3 form-check">
    <input type="checkbox" class="form-check-input" id="generate_docxf" name="generate_docxf" value="1"{% if form.generate_docxf %} checked{% endif %} title="Generate document from DOCXF">
    <label class="form-check-label" for="generate_docxf">Generate from DOCXF</label>
  </div>
  <button type="submit" class="btn btn-primary" id="next-step2" title="Proceed to next step">Next</button>
</form>

<script type="module">
  import { attachHelpText, attachTooltip } from '{{ url_for('static', filename='forms/index.js') }}';

  const templateSelect = document.getElementById('template');
  attachHelpText(templateSelect, 'Select a template to start from.');
  attachTooltip(templateSelect, 'Select a template');

  const uploadInput = document.getElementById('upload_file');
  attachHelpText(uploadInput, 'Upload the document file.');
  attachTooltip(uploadInput, 'Upload document file');

  const generateDocxf = document.getElementById('generate_docxf');
  attachHelpText(generateDocxf, 'Generate document from a DOCXF file.');
  attachTooltip(generateDocxf, 'Generate from DOCXF');

  const nextBtn = document.getElementById('next-step2');
  attachTooltip(nextBtn, 'Proceed to next step');
</script>
{% endblock %}
