{% extends "base.html" %}
{% block title %}{{ t('new_document_step3_title') }}{% endblock %}
{% block content %}
<h1 class="fw-bold" style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">{{ t('new_document_step3_title') }}</h1>
{% if form.docxf_error %}
<div class="alert alert-danger">{{ t('generation_failed', error=form.docxf_error) }}</div>
{% elif form.preview_url %}
<div class="alert alert-success">{{ t('document_generated_success') }}</div>
<div class="mb-3"><iframe src="{{ form.preview_url }}" class="w-100" style="height:600px;"></iframe></div>
{% elif form.upload_error %}
<div class="alert alert-danger">{{ t('upload_failed', error=form.upload_error) }}</div>
{% elif form.uploaded_file_key %}
<div class="alert alert-success">{{ t('file_uploaded_success') }}</div>
{% endif %}
{% if errors %}
<div class="alert alert-danger">
  <ul class="mb-0">
    {% for msg in errors.values() %}
    <li>{{ msg }}</li>
    {% endfor %}
  </ul>
</div>
<script type="module">
import { showToast } from '{{ url_for('static', filename='components/toast.js') }}';
const errors = {{ errors | tojson }};
Object.values(errors).flat().forEach(msg => showToast(msg, { timeout: 6000 }));
</script>
{% endif %}
<form method="post" action="{{ url_for('new_document', step=3) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <p><strong>{{ t('code_label') }}:</strong> {{ form.code }}</p>
  <p><strong>{{ t('title_label') }}:</strong> {{ form.title }}</p>
  <p><strong>{{ t('department_label') }}:</strong> {{ form.department }}</p>
  <p><strong>{{ t('type_label') }}:</strong> {{ form.type }}</p>
  <p><strong>{{ t('standard_label') }}:</strong> {{ standard_map.get(form.standard, form.standard) }}</p>
  <button type="submit" class="btn btn-primary">{% if form.generate_docxf %}{{ t('view_document') }}{% else %}{{ t('create') }}{% endif %}</button>
  {% if not form.generate_docxf %}<button type="button" id="save-draft" class="btn btn-secondary ms-2">{{ t('save_draft') }}</button>{% endif %}
  <button type="submit" name="cancel" value="1" class="btn btn-secondary ms-2">{{ t('cancel') }}</button>
</form>
{% if not form.generate_docxf %}
<script type="module">
import { showToast } from '{{ url_for('static', filename='components/toast.js') }}';
const messages = {
  fileNotUploaded: {{ t('file_not_uploaded') | tojson }},
  sessionEnded: {{ t('session_ended') | tojson }},
  documentUploaded: {{ t('document_uploaded_for_approval') | tojson }},
  documentCreateError: {{ t('document_create_error') | tojson }},
};

document.getElementById('save-draft').addEventListener('click', async () => {
  const data = {
    code: "{{ form.code }}",
    title: "{{ form.title }}",
    department: "{{ form.department }}",
    process: "{{ form.type }}",
    standard: "{{ form.standard }}",
    tags: "{{ form.tags }}".split(',').map(t => t.trim()).filter(Boolean),
    template: "{{ form.template }}",
    uploaded_file_key: "{{ form.uploaded_file_key }}",
    uploaded_file_name: "{{ form.uploaded_file_name }}",
    generate_docxf: {{ 'true' if form.generate_docxf else 'false' }}
  };
  if (!data.uploaded_file_key) {
    showToast(messages.fileNotUploaded, { timeout: 6000 });
    return;
  }
  const csrf = document.querySelector('input[name=csrf_token]').value;
  const response = await fetch('/api/documents', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrf
    },
    body: JSON.stringify(data)
  });
  if (response.status === 403) {
    showToast(messages.sessionEnded, { timeout: 6000 });
    return;
  }
  const result = await response.json();
  if (result.id) {
    showToast(messages.documentUploaded);
    window.location = `/documents/${result.id}?created=1`;
  } else if (result.errors) {
    Object.values(result.errors).forEach(msg => showToast(msg, { timeout: 6000 }));
  } else {
    showToast(messages.documentCreateError, { timeout: 6000 });
  }
});
</script>
{% endif %}
{% endblock %}
