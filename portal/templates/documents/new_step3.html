{% extends "base.html" %}
{% block title %}New Document - Step 3{% endblock %}
{% block content %}
<h1 class="fw-bold" style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">New Document - Step 3</h1>
{% if form.docxf_error %}
<div class="alert alert-danger">Generation failed: {{ form.docxf_error }}</div>
{% elif form.preview_url %}
<div class="alert alert-success">Document generated successfully.</div>
<div class="mb-3"><iframe src="{{ form.preview_url }}" class="w-100" style="height:600px;"></iframe></div>
{% elif form.upload_error %}
<div class="alert alert-danger">Upload failed: {{ form.upload_error }}</div>
{% elif form.uploaded_file_key %}
<div class="alert alert-success">File uploaded successfully.</div>
{% endif %}
{% if errors %}
<div class="alert alert-danger">
  <ul class="mb-0">
    {% for msg in errors.values() %}
    <li>{{ msg }}</li>
    {% endfor %}
  </ul>
</div>
<script type="module">
import { showToast } from '{{ url_for('static', filename='components/index.js') }}';
const errors = {{ errors | tojson }};
Object.values(errors).flat().forEach(msg => showToast(msg, { timeout: 6000 }));
</script>
{% endif %}
<form method="post" action="{{ url_for('new_document', step=3) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <p><strong>Code:</strong> {{ form.code }}</p>
  <p><strong>Title:</strong> {{ form.title }}</p>
  <p><strong>Department:</strong> {{ form.department }}</p>
  <p><strong>Type:</strong> {{ form.type }}</p>
  <p><strong>Standard:</strong> {{ standard_map.get(form.standard, form.standard) }}</p>
  <button type="submit" class="btn btn-primary">{% if form.generate_docxf %}View Document{% else %}Create{% endif %}</button>
  {% if not form.generate_docxf %}<button type="button" id="save-draft" class="btn btn-secondary ms-2">Taslak olarak kaydet</button>{% endif %}
  <button type="submit" name="cancel" value="1" class="btn btn-secondary ms-2">Cancel</button>
</form>
{% if not form.generate_docxf %}
<script type="module">
import { showToast } from '{{ url_for('static', filename='components/index.js') }}';

document.getElementById('save-draft').addEventListener('click', async () => {
  const data = {
    code: "{{ form.code }}",
    title: "{{ form.title }}",
    department: "{{ form.department }}",
    process: "{{ form.type }}",
    standard: "{{ form.standard }}",
    tags: "{{ form.tags }}".split(',').map(t => t.trim()).filter(Boolean),
    template: "{{ form.template }}",
    uploaded_file_key: "{{ form.uploaded_file_key }}",
    uploaded_file_name: "{{ form.uploaded_file_name }}",
    generate_docxf: {{ 'true' if form.generate_docxf else 'false' }}
  };
  if (!data.uploaded_file_key) {
    showToast('Dosya yüklenemedi', { timeout: 6000 });
    return;
  }
  const response = await fetch('/api/documents', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(data)
  });
  const result = await response.json();
  if (result.id) {
    showToast('Doküman başarıyla yüklendi ve onaya gönderildi');
    window.location = `/documents/${result.id}?created=1`;
  } else if (result.errors) {
    Object.values(result.errors).forEach(msg => showToast(msg, { timeout: 6000 }));
  } else {
    showToast('Doküman oluşturulurken bir hata oluştu', { timeout: 6000 });
  }
});
</script>
{% endif %}
{% endblock %}
