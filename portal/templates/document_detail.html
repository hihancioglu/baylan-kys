{% extends "base.html" %}

{% block title %}{{ doc.title }}{% endblock %}

{% block page_actions %}
<link rel="stylesheet" href="{{ url_for('static', filename='toolbar/toolbar.css') }}">
<div class="toolbar" data-component="toolbar" data-variant="icon-text">
  {% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
    {% if doc.status in ['Review', 'Approved'] %}
      {% if doc.file_key %}
      <form id="publish-form" hx-post="/api/documents/{{ doc.id }}/publish" hx-swap="none" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-primary" id="publish-button">Publish</button>
      </form>
      {% else %}
      <button type="button" class="btn btn-primary" id="publish-button" disabled title="No active version">Publish (No active version)</button>
      {% endif %}
    {% elif doc.status == 'Draft' %}
    <button type="button" class="btn btn-primary" id="publish-button" disabled title="Document is in draft status">Publish (Draft)</button>
    {% else %}
    <button type="button" class="btn btn-primary" id="publish-button" disabled title="Publish unavailable">Publish</button>
    {% endif %}
  {% endif %}
  {% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
    {% if doc.status == 'Published' %}
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
      Assign Mandatory Reading <span class="badge bg-secondary" id="assignment-count">{{ ack_count }}</span>
    </button>
    {% else %}
    <button type="button" class="btn btn-outline-primary" disabled>
      Assign Mandatory Reading <span class="badge bg-secondary" id="assignment-count">{{ ack_count | default(0) }}</span>
    </button>
    {% endif %}
  {% endif %}
  {% if preview %}
  <a class="btn btn-primary" href="{{ preview.url }}" target="_blank">Preview (PDF)</a>
  {% else %}
  <button type="button" class="btn btn-secondary" disabled>Önizleme mevcut değil</button>
  {% endif %}
  {% if can_download %}
  <a class="btn btn-outline-secondary" href="/documents/{{ doc.id }}/download?version=v{{ doc.major_version }}.{{ doc.minor_version }}">Download</a>
  {% endif %}
  {% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
    {% if can_upload_version %}
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadVersionModal">Upload New Version</button>
    {% endif %}
  {% endif %}
  {% if has_role('admin') or has_role('quality') %}
  <div class="btn-group">
    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
      Sürüm İşlemleri
    </button>
    <ul class="dropdown-menu">
      <li>
        <form id="increment-major-form" hx-patch="/api/documents/{{ doc.id }}/versioning" hx-swap="none">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="action" value="increment_major">
          <button type="submit" class="dropdown-item">Majör Sürümü Artır</button>
        </form>
      </li>
    </ul>
  </div>
  {% endif %}
</div>
<script type="module" src="{{ url_for('static', filename='toolbar/toolbar.js') }}"></script>
{% endblock %}

{% block content %}
<h1>{{ doc.title }}</h1>
{% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
  {% if doc.locked_by and doc.lock_expires_at and doc.lock_expires_at > now %}
    {% if current_user and current_user.id == doc.locked_by %}
    <div class="alert alert-info">Checked out by you until {{ doc.lock_expires_at }}.</div>
    {% if can_checkin %}
    <form class="mb-3" hx-post="/api/documents/{{ doc.id }}/checkin" hx-swap="none">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-warning">Check in</button>
    </form>
    {% endif %}
    {% else %}
    <div class="alert alert-warning">Locked by {{ doc.lock_owner.username if doc.lock_owner else 'another user' }} until {{ doc.lock_expires_at }}.</div>
    {% if can_override or 'quality_admin' in user_roles %}
    <form class="mb-3" hx-post="/api/documents/{{ doc.id }}/checkin" hx-swap="none">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-danger">Force Check in</button>
    </form>
    {% endif %}
    {% endif %}
  {% else %}
    {% if can_checkout %}
    <form class="mb-3" hx-post="/api/documents/{{ doc.id }}/checkout" hx-swap="none">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-outline-primary">Check out</button>
    </form>
    {% endif %}
  {% endif %}
{% endif %}
<ul>
  <li><strong>Code:</strong> {{ doc.code }}</li>
  <li><strong>Status:</strong> {{ doc.status }}</li>
  <li><strong>Tags:</strong> {{ doc.tags or "" }}</li>
</ul>

<h2>Revision History</h2>
{% include "partials/documents/_versions.html" %}

{% include "partials/_audit_log.html" %}

  <div class="toolbar" data-component="toolbar">
    <a class="btn btn-secondary" href="{{ url_for('list_documents') }}">Back to documents</a>
    {% if can_download %}
    <a class="btn btn-secondary" href="{{ url_for('document_download', doc_id=doc.id) }}?version=v{{ doc.major_version }}.{{ doc.minor_version }}">Download</a>
    {% endif %}
  </div>

{% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
  {% if can_upload_version %}
  <div class="modal fade" id="uploadVersionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="upload-version-form" hx-post="/api/documents/{{ doc.id }}/versions" hx-target="#version-list" hx-swap="outerHTML" hx-encoding="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Upload New Version</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <input type="file" name="file" required>
            </div>
            <div class="mb-3">
              <input type="text" class="form-control" name="notes" placeholder="Revision notes">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
{% endif %}

{% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="assign-form" hx-post="/api/ack/assign" hx-swap="none">
        <div class="modal-header">
          <h5 class="modal-title">Assign Mandatory Reading</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="doc_id" value="{{ doc.id }}">
          <div class="mb-3">
            <label class="form-label" for="assign-due-at">Due Date</label>
            <input type="date" class="form-control" id="assign-due-at" name="due_at">
          </div>
          <div class="mb-3">
            <label class="form-label">Roles</label>
            {% for role in roles %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="role-{{ role.id }}" name="targets" value="{{ role.name }}">
              <label class="form-check-label" for="role-{{ role.id }}">{{ role.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label class="form-label">Users</label>
            <div class="overflow-auto" style="max-height: 200px;">
              {% for user in users %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="user-{{ user.id }}" name="targets" value="{{ user.id }}">
                <label class="form-check-label" for="user-{{ user.id }}">{{ user.username }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script type="module" src="{{ url_for('static', filename='document_detail.js') }}"></script>
<script type="module">
import { showToast } from '{{ url_for('static', filename='components/toast.js') }}';
document.addEventListener('htmx:responseError', function (evt) {
  if (evt.target.id === 'publish-form') {
    let message = 'Failed to publish document';
    try {
      const data = JSON.parse(evt.detail.xhr.responseText);
      if (data && data.error) {
        message = data.error;
      }
    } catch (e) {
      // ignore JSON parse errors
    }
    showToast(message, { timeout: 6000 });
  }
});
</script>
{% if request.args.get('created') %}
<script type="module">
import { showToast } from '{{ url_for('static', filename='components/toast.js') }}';
showToast('Doküman başarıyla yüklendi ve onaya gönderildi');
</script>
{% endif %}
{% endblock %}

