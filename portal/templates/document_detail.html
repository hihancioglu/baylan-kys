{% extends "base.html" %}

{% block title %}{{ doc.title }}{% endblock %}

{% block page_actions %}
<link rel="stylesheet" href="{{ url_for('static', filename='toolbar/toolbar.css') }}">
<div class="toolbar" data-component="toolbar" data-variant="icon-text">
  {% if doc.status == 'Approved' %}
  <form id="publish-form" hx-post="/api/documents/{{ doc.id }}/publish" hx-swap="none" class="d-inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-primary">Publish</button>
  </form>
  {% endif %}
  {% if doc.status == 'Published' %}
  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
    Assign Mandatory Reading <span class="badge bg-secondary" id="assignment-count">{{ ack_count }}</span>
  </button>
  {% endif %}
</div>
<script type="module" src="{{ url_for('static', filename='toolbar/toolbar.js') }}"></script>
{% endblock %}

{% block content %}
<h1>{{ doc.title }}</h1>
{% if preview.type %}
<div id="preview-container" class="mb-4"></div>
<script>
  window.previewData = {{ preview | tojson }};
</script>
<script type="module" src="{{ url_for('static', filename='document_preview.js') }}"></script>
{% endif %}
<ul>
  <li><strong>Code:</strong> {{ doc.code }}</li>
  <li><strong>Status:</strong> {{ doc.status }}</li>
  <li><strong>Tags:</strong> {{ doc.tags or "" }}</li>
</ul>

<h2>Revision History</h2>
{% if revisions %}
<ul>
  {% for rev in revisions %}
  <li>Version {{ rev.major_version }}.{{ rev.minor_version }} â€“ {{ rev.created_at.strftime('%Y-%m-%d') }}</li>
  {% endfor %}
</ul>
{% else %}
<p>No revisions found.</p>
{% endif %}

{% include "partials/_audit_log.html" %}

<p>
  <a href="{{ url_for('list_documents') }}">Back to documents</a>
  {% if download_url %}
  | <a href="{{ download_url }}">Download</a>
  {% endif %}
</p>

<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="assign-form" hx-post="/api/ack/assign" hx-swap="none">
        <div class="modal-header">
          <h5 class="modal-title">Assign Mandatory Reading</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="doc_id" value="{{ doc.id }}">
          <div class="mb-3">
            <label class="form-label">Roles</label>
            {% for role in roles %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="role-{{ role.id }}" name="targets" value="{{ role.name }}">
              <label class="form-check-label" for="role-{{ role.id }}">{{ role.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label class="form-label">Users</label>
            <div class="overflow-auto" style="max-height: 200px;">
              {% for user in users %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="user-{{ user.id }}" name="targets" value="{{ user.id }}">
                <label class="form-check-label" for="user-{{ user.id }}">{{ user.username }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module" src="{{ url_for('static', filename='document_detail.js') }}"></script>
<script>
document.addEventListener('htmx:responseError', function (evt) {
  if (evt.target.id === 'publish-form') {
    let message = 'Failed to publish document';
    try {
      const data = JSON.parse(evt.detail.xhr.responseText);
      if (data && data.error) {
        message = data.error;
      }
    } catch (e) {
      // ignore JSON parse errors
    }
    alert(message);
  }
});
</script>
{% endblock %}

