<div id="tab-versions">
  <form id="version-list" method="get" action="{{ url_for('compare_document_versions', doc_id=doc.id) }}">
    <div class="row">
      <div class="col-md-8">
        <div class="table-responsive">
          {% if revisions %}
          <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th scope="col">Version</th>
              <th scope="col">Date</th>
              <th scope="col">Uploaded By</th>
              <th scope="col">Note</th>
              {% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
              <th scope="col">Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for rev in revisions %}
            <tr>
              <td>
                <div class="form-check mb-0">
                  <input class="form-check-input me-2 version-checkbox" type="checkbox" name="rev_id" value="{{ rev.id }}" id="rev-{{ rev.id }}" data-label="{{ rev.major_version }}.{{ rev.minor_version }}" data-download-url="{{ url_for('get_file', file_key=rev.file_key) }}" hx-get="{{ url_for('document_detail', doc_id=doc.id, revision_id=rev.id) }}" hx-target="#revision-panel" hx-select="#revision-note" hx-swap="innerHTML" hx-trigger="change" hx-push-url="false">
                  <label class="form-check-label" for="rev-{{ rev.id }}">{{ rev.major_version }}.{{ rev.minor_version }}</label>
                </div>
              </td>
              <td class="text-muted">{{ rev.created_at.strftime('%Y-%m-%d') if rev.created_at else '' }}</td>
              <td>{{ rev.user.username if rev.user else '' }}</td>
              <td>{{ rev.revision_notes or '' }}</td>
              {% if has_role('editor') or has_role('publisher') or has_role('quality_admin') %}
              <td>
                <form class="d-inline rollback-form" hx-post="{{ url_for('rollback_document_api', doc_id=doc.id) }}?to=v{{ rev.major_version }}.{{ rev.minor_version }}" hx-swap="none">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Rollback</button>
                </form>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="text-center p-4 empty-state" role="status">
          <svg class="icon mb-2" aria-hidden="true"><use href="#icon-upload"></use></svg>
          <p class="mb-2">{{ t('no_versions_yet') }}</p>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadVersionModal">{{ t('upload_new_version') }}</button>
        </div>
        {% endif %}
      </div>
      {% if can_server_diff %}
      <button type="submit" id="compare-button" class="btn btn-secondary mt-2" data-can-server-diff="true" disabled>Compare</button>
      {% else %}
      <button type="button" id="compare-button" class="btn btn-secondary mt-2" data-can-server-diff="false" disabled>Compare</button>
      {% endif %}
    </div>
    <div class="col-md-4">
      <div id="revision-panel">
        {% if revision %}
        <div id="revision-note">
          <h5>Version {{ revision.major_version }}.{{ revision.minor_version }}</h5>
          <p>{{ revision.revision_notes or 'No revision notes.' }}</p>
          <button type="button" id="compare-to-button" class="btn btn-outline-primary mt-2"
            data-url="{{ url_for('compare_document_versions', doc_id=doc.id) }}"
            data-rev-id="{{ revision.id }}">Compare toâ€¦</button>
          {% if can_download %}
          <a class="btn btn-outline-secondary mt-2" href="{{ url_for('document_download', doc_id=doc.id) }}?version=v{{ revision.major_version }}.{{ revision.minor_version }}">Download</a>
          {% endif %}
        </div>
        {% else %}
        <div id="revision-note">
          <p>Select a version to view its note.</p>
        </div>
        {% endif %}
      </div>
      <h5 class="mt-3">Selected Versions</h5>
      <ul id="selected-versions" class="list-group"></ul>
      <a id="download-rev-a" class="btn btn-outline-secondary mt-2 d-none" download>Download A</a>
      <a id="download-rev-b" class="btn btn-outline-secondary mt-2 d-none" download>Download B</a>
    </div>
  </div>
</form>

<div class="modal fade" id="local-compare-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Compare Locally</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Download the two selected versions using the buttons above. Then open one of the files in Microsoft Word or Excel and use the "Compare" feature to select the other file and view the differences.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

</div>
